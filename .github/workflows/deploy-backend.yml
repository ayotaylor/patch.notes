name: Deploy Backend to Azure Container Apps

on:
  push:
    branches: [main]
    paths:
      - 'Backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Allows manual trigger from GitHub UI

env:
  AZURE_CONTAINER_REGISTRY: patchnotesacr
  CONTAINER_APP_NAME: patchnotes-backend
  RESOURCE_GROUP: patchnotes
  IMAGE_NAME: patchnotes-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push Docker image
        working-directory: ./Backend
        run: |
          IMAGE_TAG="${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"

          echo "Building image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .

          echo "Pushing image to ACR..."
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy to Azure Container Apps
        run: |
          echo "Deploying image: ${{ env.IMAGE_TAG }}"

          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.IMAGE_TAG }} \
            --revision-suffix $(date +%s)

      - name: Get Container App URL
        id: get-url
        run: |
          URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "APP_URL=https://$URL" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** https://$URL" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Health check
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30

          echo "Checking application health..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.get-url.outputs.APP_URL }}" --max-time 60 || echo "000")

          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "404" ]; then
            echo "âœ“ Application is responding (HTTP $HTTP_STATUS)"
          else
            echo "âš  Application returned HTTP $HTTP_STATUS"
            echo "Check logs: az containerapp logs show -n ${{ env.CONTAINER_APP_NAME }} -g ${{ env.RESOURCE_GROUP }} --follow"
          fi
